<!DOCTYPE html>

<html>
<head>
<link rel="stylesheet" type="text/css" href="moviezone.css">
<script src="ethlightjs.min.js"></script>
<script>

  var api;
  var keystore;
  var helpers = ethlightjs.helpers;
  var password;
  var seed;
  var registryAddr = "6e322c26237d791c52baa51fd925b6d9c298cd6e"; 
  var nonce;

  function testChooseAddr(){
    var addr= document.getElementById(document.querySelector('input[name="addr"]:checked').value).value;
    document.getElementById("userAddr").value = addr;
  }

  function testChooseiTime(){
    var iTime = document.getElementById(document.querySelector('input[name="best"]:checked').value).value;
    document.getElementById("iTime").value = iTime;
  }

  function testChoosebTime(){
    var bTime = document.getElementById(document.querySelector('input[name="tip"]:checked').value).value;
    document.getElementById("bTime").value = bTime;
  }


  function getAddrs() {
    seed = document.getElementById("seed").value;
    password = document.getElementById("password").value;
    api = new ethlightjs.blockchainapi.blockappsapi("http://stablenet.blockapps.net")
    keystore = new ethlightjs.keystore(seed, password);

    var addr0 = keystore.generateNewAddress(password);
    var bal0 = api.getBalance(addr0, function(err, bal) {
        document.getElementById("addr0").value = addr0;
        document.getElementById("addr0").innerHTML = addr0 + " (" + (bal / 1.0e18) + " ETH)";
    })
    var addr1 = keystore.generateNewAddress(password);
    var bal1 = api.getBalance(addr1, function(err, bal) {
        document.getElementById("addr1").value = addr1;
        document.getElementById("addr1").innerHTML = addr1 + " (" + (bal / 1.0e18) + " ETH)";
    })
    var addr2 = keystore.generateNewAddress(password);
    var bal2 = api.getBalance(addr2, function(err, bal) {
        document.getElementById("addr2").value = addr2;
        document.getElementById("addr2").innerHTML = addr2 + " (" + (bal / 1.0e18) + " ETH)";
    })
  }

  function checkNonce(callback) {
    var userAddr = document.getElementById("userAddr").value;
    api.getNonce(userAddr, callback);
  }

  function pushUserContract() {
    var fromAddr = document.getElementById("userAddr").value;
    var txObj = {gaslimit: 3000000, nonce: nonce};
    helpers.sendCreateContractTx(userContractCode, fromAddr, txObj, api,
                                 keystore, password, function(err, contractAddr) {
      document.getElementById("userContractAddr").value = contractAddr; 
    });
  }

  function registerUserContract() {
    var contractAddr = registryAddr;
    var fromAddr = document.getElementById("userAddr").value;
    var txData = {nonce: nonce};
    var args = [parseInt(document.getElementById("userContractAddr").value, 16)]
    helpers.sendFunctionTx(registryABI, contractAddr, "register", args, fromAddr, txData, api, keystore, password, function(undefined, undefined){});
  }

  function initUserContract() {
    var contractAddr = document.getElementById("userContractAddr").value;
    var fromAddr = document.getElementById("userAddr").value;
    var txData = {nonce: nonce};
    var iTime = parseInt(document.getElementById("iTime").value);
    var bTime = parseInt(document.getElementById("bTime").value);
    var bribePrice = parseInt(document.getElementById("t").value);
    var charity = parseInt(document.getElementById("c").value);
    var name = document.getElementById("name").value;
    var args = [iTime, bTime, bribePrice, charity, name]
      helpers.sendFunctionTx(userContractABI, contractAddr, "init", args, fromAddr, txData, api, keystore, password, function(undefined, undefined){});
  }

  function queryRegistry() {
    var fromAddr = document.getElementById("userAddr").value;
    var txData = {nonce: nonce};
    helpers.sendFunctionTx(registryABI, registryAddr, "testReturn", [], fromAddr, txData, api, keystore, password, function(undefined, undefined){});
  }

  var userContractCode =
 "60606040525b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b60fe8061003f6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900480630eb7a276146037576035565b005b605e6004803590602001803590602001803590602001803590602001803590602001506060565b005b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614158060bc5750813414155b1560c45760f7565b84600160005081905550836002600050819055508260036000508190555081600460005081905550806005600050819055505b505050505056"

 var registryABI = [{"constant":false,"inputs":[{"name":"userContract","type":"address"}],"name":"register","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"sendingUserLoc","type":"uint256"},{"name":"index","type":"uint256"}],"name":"matchmakerHelper","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_user","type":"address"},{"name":"_idealTime","type":"uint256"},{"name":"_bribeTime","type":"uint256"},{"name":"_bribePrice","type":"uint256"},{"name":"_charity","type":"uint256"},{"name":"_name","type":"bytes32"}],"name":"loadInUser","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"index","type":"uint256"}],"name":"makeOptimalMatch","outputs":[],"type":"function"},{"constant":false,"inputs":[],"name":"testReturn","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"user","type":"address"}],"name":"addMatch","outputs":[],"type":"function"},{"inputs":[],"type":"constructor"}]


  var userContractABI = [{"constant":false,"inputs":[{"name":"_idealTime","type":"uint256"},{"name":"_bribeTime","type":"uint256"},{"name":"_bribePrice","type":"uint256"},{"name":"_charity","type":"uint256"},{"name":"_name","type":"bytes32"}],"name":"init","outputs":[],"type":"function"},{"inputs":[],"type":"constructor"}]

</script>
</head>
<body>
<center>
<h1 >This is Moviezone.</h1>
<h2 >Generate Your addresses</h2>
<h2>Seed: <input type="text" id="seed" value="vocal cradle afford addict expose toe suggest illness eager vote satisfy latin"></h2>
<h2>Password: <input type="password" id=password value="password"></h2>
<button onclick="getAddrs()">Get addresses</button>
  
<h2>Choose Your addresses:</h2>
<h2 id=addresses></h2>
<table>
<tr>
<td><input type=radio name="addr" value="addr0" onclick="testChooseAddr()"></td>
<td><label id=addr0></label></td>
</tr>
<tr>
<td><input type=radio name="addr" value="addr1" onclick="testChooseAddr()"></td>
<td><label id=addr1></label></td>
</tr>
<tr>
<td><input type=radio name="addr" value="addr2" onclick="testChooseAddr()"></td>
<td><label id=addr2></label></td>
</tr>
</table>
<h2>Your address: <input type="text" id="userAddr" value=""></h2>
<br>

<h2>Choose Your Time:</h2>
<table>
<tr>
<td>Ideal</td> <td>Bribe</td> <td>Timeslot</td>  
</tr>
<tr>
<td><input type="radio" name="best" value="1" onclick="testChooseiTime"> </td>
<td><input type="radio" name="tip" value="1" onclick="testChoosebTime"></td>
<td><label>16:00</label></td> 
</tr>
<tr>
<td><input type="radio" name="best" value="2" onclick="testChooseiTime"></td>
<td><input type="radio" name="tip" value="2" onclick="testChoosebTime"></td>
<td><label>18:00</label></td> 
</tr>
<tr>
<td><input type="radio" name="best" value="3" onclick="testChooseiTime"></td>
<td><input type="radio" name="tip" value="3" onclick="testChoosebTime"></td>
<td><label>20:00</label></td> 
</tr>
</table>

<h2>Tip:</h2>
<input id='t' type="text" value="0">
<br>
<h2>Charity:</h2>
<input id='c' type="text" value="0">
<br>
<button onclick="checkNonce(function(err, _nonce){nonce = _nonce})" class="select">Step 0</button>
<button onclick="pushUserContract()" class="select">Step 1</button>
<button onclick="registerUserContract()" class="select">Step 2</button>
<button onclick="initUserContract()" class="select">Step 3</button>


<h2>Contract address: <input type="text" id="userContractAddr" value=""></h2>
</center>
</body>
</html>
