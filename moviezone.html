<!DOCTYPE html>

<html>
<head>
<script src="ethlightjs.min.js"></script>
<script>

  var api;
  var keystore;
  var helpers = ethlightjs.helpers;
  var password;
  var seed;
  var registryAddr = "6a3780b05cda96d559b38ec40ccf055ed1a3b6a0"; 
  var nonce;

  function testChooseAddr(){
    var addr= document.getElementById(document.querySelector('input[name="addr"]:checked').value).value;
    document.getElementById("userAddr").value = addr;
  }

  function testChooseiTime(){
    var iTime = document.getElementById(document.querySelector('input[name="best"]:checked').value).value;
    document.getElementById("iTime").value = iTime;
  }

  function testChoosebTime(){
    var bTime = document.getElementById(document.querySelector('input[name="tip"]:checked').value).value;
    document.getElementById("bTime").value = bTime;
  }


  function getAddrs() {
    seed = document.getElementById("seed").value;
    password = document.getElementById("password").value;
    api = new ethlightjs.blockchainapi.blockappsapi("http://stablenet.blockapps.net")
    keystore = new ethlightjs.keystore(seed, password);

    var addr0 = keystore.generateNewAddress(password);
    var bal0 = api.getBalance(addr0, function(err, bal) {
        document.getElementById("addr0").value = addr0;
        document.getElementById("addr0").innerHTML = addr0 + " (" + (bal / 1.0e18) + " ETH)";
    })
    var addr1 = keystore.generateNewAddress(password);
    var bal1 = api.getBalance(addr1, function(err, bal) {
        document.getElementById("addr1").value = addr1;
        document.getElementById("addr1").innerHTML = addr1 + " (" + (bal / 1.0e18) + " ETH)";
    })
    var addr2 = keystore.generateNewAddress(password);
    var bal2 = api.getBalance(addr2, function(err, bal) {
        document.getElementById("addr2").value = addr2;
        document.getElementById("addr2").innerHTML = addr2 + " (" + (bal / 1.0e18) + " ETH)";
    })
  }

  function checkNonce(callback) {
    var userAddr = document.getElementById("userAddr").value;
    api.getNonce(userAddr, callback);
  }

  function pushUserContract() {
    var fromAddr = document.getElementById("userAddr").value;
    var txObj = {gaslimit: 3000000, nonce: nonce};
    helpers.sendCreateContractTx(userContractCode, fromAddr, txObj, api,
                                 keystore, password, function(err, contractAddr) {
      document.getElementById("userContractAddr").value = contractAddr; 
    });
  }

  /* THIS WILL BE WHAT HAPPENS WHEN A USER JOINS THE POOL 
  function joinPool() {
    checkNonce(function(error, nonce) { 
      pushUserContract(nonce, registerUserContract(nonce++, function() { 
          initUserContract;
        }));
      });
  } */

  function registerUserContract() {
    //nonce++;
    var contractAddr = registryAddr;
    var fromAddr = document.getElementById("userAddr").value;
    var txData = {nonce: nonce};
    var args = [parseInt(document.getElementById("userContractAddr").value, 16)]
      helpers.sendFunctionTx(registryABI, contractAddr, "register", args, fromAddr, txData, api, keystore, password, function(undefined, undefined){});
  }

  function initUserContract() {
    nonce++;
    var contractAddr = document.getElementById("userContractAddr").value;
    var fromAddr = document.getElementById("userAddr").value;
    var txData = {nonce: nonce};
    var iTime = document.getElementById("iTime").value;
    var bTime = document.getElementById("bTime").value;
    var bribePrice = document.getElementById("t").value;
    var charity = document.getElementById("c").value;
    var name = document.getElementById("name").value;
    var args = [iTime, bTime, bribePrice, charity, name]
      helpers.sendFunctionTx(userContractABI, contractAddr, "init", args, fromAddr, txData, api, keystore, password, function(undefined, undefined){});
  }


  var registryCode =
 "60606040527f4d41444d4158000000000000000000000000000000000000000000000000000060006000505560056001600050555b600060026000508190555060006014600050819055505b6106db8061005a6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900480634420e4861461006557806364a2fb24146100785780636dadc82114610091578063c0007e0b146100c2578063fd02fa67146100d557610063565b005b6100766004803590602001506100e8565b005b61008f6004803590602001803590602001506103ce565b005b6100c06004803590602001803590602001803590602001803590602001803590602001803590602001506101b6565b005b6100d3600480359060200150610336565b005b6100e66004803590602001506104a2565b005b60016000505460026000505414156100ff576101b3565b80600360005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555033600460005060026000505460058110156100025790900160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060026000818150548092919060010191905055506101b26000610336565b5b50565b6000600060016000505460146000505414156101d15761032c565b8782825060000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055508682825060010160005081905550858282506002016000508190555084828250600301600050819055508382825060040160005081905550828282506005016000508190555081816015600050601460005054600581101561000257909060060201600060006000858201819054906101000a900473ffffffffffffffffffffffffffffffffffffffff16848301826101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690830217905550505060016000858201815054848301825055505060026000858201815054848301825055505060036000858201815054848301825055505060046000858201815054848301825055505060056000858201815054848301825055505091509150505060146000818150548092919060010191905055505b5050505050505050565b60003373ffffffffffffffffffffffffffffffffffffffff1660156000508360058110156100025790906006020160005060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156103ba578190506103b58160006103ce565b6103ca565b6103c982806001019350610336565b5b5050565b60006000600060006014600050548514156103e85761049a565b848614156104055761040086868060010197506103ce565b61049a565b601560005086600581101561000257909060060201600093509350601560005085600581101561000257909060060201600091509150818150600101600050548484506001016000505414156104855761048482825060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166104a2565b5b61049586868060010197506103ce565b61049a565b505050505050565b6000600e60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156105135780600e60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506106d7565b6000600f60009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156105845780600f60006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506106d6565b6000601060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156105f55780601060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506106d5565b6000601160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156106665780601160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506106d4565b6000601260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156106d35780601260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b5b5b5b5b5b5056"

  var userContractCode =
 "60606040525b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b60fe8061003f6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900480630eb7a276146037576035565b005b605e6004803590602001803590602001803590602001803590602001803590602001506060565b005b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614158060bc5750813414155b1560c45760f7565b84600160005081905550836002600050819055508260036000508190555081600460005081905550806005600050819055505b505050505056"

  var registryABI =
 [{"constant":false,"inputs":[{"name":"userContract","type":"address"}],"name":"register","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"sendingUserLoc","type":"uint256"},{"name":"index","type":"uint256"}],"name":"matchmakerHelper","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_user","type":"address"},{"name":"_idealTime","type":"uint256"},{"name":"_bribeTime","type":"uint256"},{"name":"_bribePrice","type":"uint256"},{"name":"_charity","type":"uint256"},{"name":"_name","type":"bytes32"}],"name":"loadInUser","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"index","type":"uint256"}],"name":"makeOptimalMatch","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"user","type":"address"}],"name":"addMatch","outputs":[],"type":"function"},{"inputs":[],"type":"constructor"}]

  var userContractABI = [{"constant":false,"inputs":[{"name":"_idealTime","type":"uint256"},{"name":"_bribeTime","type":"uint256"},{"name":"_bribePrice","type":"uint256"},{"name":"_charity","type":"uint256"},{"name":"_name","type":"bytes32"}],"name":"init","outputs":[],"type":"function"},{"inputs":[],"type":"constructor"}]

</script>
</head>

<h1>This is Moviezone.</h1>

<h2>Seed: <input type="text" id="seed" value="vocal cradle afford addict expose toe suggest illness eager vote satisfy latin"></h2>
<h2>Password: <input type="password" id=password value="password"></h2>
<button onclick="getAddrs()">Get addresses</button>
  
<h2>Choose Your addresses:</h2>
<h2 id=addresses></h2>
<input type=radio name="addr" value="addr0" onclick="testChooseAddr()"><h3 id=addr0></h3><br>
<input type=radio name="addr" value="addr1" onclick="testChooseAddr()"><h3 id=addr1></h3><br>
<input type=radio name="addr" value="addr2" onclick="testChooseAddr()"><h3 id=addr2></h3><br>

<h2>Name: <input type="text" id="name" value=""></h2>
<h2>Your address: <input type="text" id="userAddr" value=""></h2>
<br>

<h2>Choose Your Time:</h2>
Ideal &nbsp; Bribe &nbsp;  Time  
<br>
<input type="radio" name="best" value="1" onclick="testChooseiTime"> &nbsp;&nbsp;&nbsp;&nbsp; <input type="radio" name="tip" value="1" onclick="testChoosebTime">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16:00 
<br>
<input type="radio" name="best" value="2" onclick="testChooseiTime"> &nbsp;&nbsp;&nbsp;&nbsp; <input type="radio" name="tip" value="2" onclick="testChoosebTime">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;18:00 
<br>
<input type="radio" name="best" value="3" onclick="testChooseiTime"> &nbsp;&nbsp;&nbsp;&nbsp; <input type="radio" name="tip" value="3" onclick="testChoosebTime">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20:00 
<br>
<h2>Tip:</h2>
<input id='t' type="text" value="0">
<br>
<h2>Charity:</h2>
<input id='c' type="text" value="0">
<br>
<button onclick="checkNonce(function(err, _nonce){nonce = _nonce})" class="select">Step 0</button>
<button onclick="pushUserContract()" class="select">Step 1</button>
<button onclick="registerUserContract()" class="select">Step 2</button>
<button onclick="initUserContract()" class="select">Step 3</button>


<h2>Contract address: <input type="text" id="userContractAddr" value=""></h2>
<h2>Contract address: <input type="text" id="iTime" value="1"></h2>
<h2>Contract address: <input type="text" id="bTime" value="2"></h2>


</html>
